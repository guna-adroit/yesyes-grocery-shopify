{% comment %}
  Quick Add Popup Section for Horizon theme
  Dynamically loaded via Section Rendering API
{% endcomment %}

<quick-add-popup id="QuickAddPopup" class="quick-add-popup hidden" role="dialog" aria-modal="true">
  <div class="popup-overlay"></div>
  <div class="popup-content">
    <button class="popup-close" aria-label="Close">
      {{- 'icon-close.svg' | inline_asset_content -}}
    </button>
    <div id="QuickAddPopupContent" class="quick-add-popup__content">
        <h2>{{ product.title }}</h2>
        {%unless product.has_only_default_variant %}
        
          <div class="variants-container">
        {% for variant in product.variants %}
          <div class="product_variant_item" style="margin-bottom: 1.5rem; border: 1px solid #eee; padding: 1rem; border-radius: 8px;">
            
            <div class="product_variant-image">
                <img 
                  src="{{ variant.featured_image | default: product.featured_image | image_url: width: 200 }}" 
                  alt="{{ variant.title | escape }}"
                  height=""
                  width=""
                  loading="lazy"
                >
              </div>

              <div class="product_variant-title">
                <p>{{ product.title }}</p>
                <p class="product_variant-name">{{ variant.title }}</p>
              </div>

              <div class="product_variant-price-container">
                <div class="product_variant-price">
                  <span class="product-price">{{ variant.price | money }}</span>

                  {% if variant.compare_at_price > variant.price %}
                    <span class="product-compare-price">{{ variant.compare_at_price | money }}</span>
                  {% endif %}
                </div>

                {% if variant.unit_price_measurement %}
                  <div class="product_variant-details">
                    <span>
                      {{ variant.unit_price | money }}/{{ variant.unit_price_measurement.reference_unit }}
                    </span>
                  </div>
                {% endif %}
              </div>

              {% if variant.available %}
                 <form action="/cart/add" method="post" class="add-to-cart-form">
                    <input type="hidden" name="id" value="{{ variant.id }}">

                    <label for="Quantity-{{ variant.id }}" class="add-to-cart-label">
                      Quantity
                    </label>
                    <input
                      id="Quantity-{{ variant.id }}"
                      type="number"
                      name="quantity"
                      value="1"
                      min="1"
                      class="add-to-cart-quantity"
                    >

                    <button type="submit" class="add-to-cart-button">
                      Add to Cart
                    </button>
                  </form>

                  <div class="cart-message" aria-live="polite"></div>


              {% else %}
                <button disabled style="background:#ccc; color:#666; border:none; padding:8px 16px; border-radius:4px;">
                  Sold Out
                </button>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <script>
          document.addEventListener('DOMContentLoaded', function () {
  const forms = document.querySelectorAll('form.add-to-cart-form');

  if (!forms.length) {
    console.warn('No add-to-cart forms found.');
    return;
  }

  forms.forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // ✅ Stops full page reload
      console.log('Intercepted form submit'); // debug line

      const formData = new FormData(form);
      const button = form.querySelector('.add-to-cart-button');
      const message = form.nextElementSibling;

      button.disabled = true;
      button.textContent = 'Adding...';

      try {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.description || 'Error adding to cart');
        }

        const data = await response.json();
        console.log('Added to cart:', data); // ✅ should log variant data

        message.textContent = 'Added to cart!';
        message.className = 'cart-message cart-message--success';
        message.style.display = 'block';
      } catch (err) {
        console.error('Add to cart failed:', err);
        message.textContent = 'Error adding to cart';
        message.className = 'cart-message cart-message--error';
        message.style.display = 'block';
      } finally {
        button.disabled = false;
        button.textContent = 'Add to Cart';
        setTimeout(() => (message.style.display = 'none'), 2000);
      }
    });
  });
});

        </script>


        
        {% comment %} {% else %}
          {% content_for 'block', type: 'price', id: 'price' %}
          {% liquid
            assign product_resource = closest.product
            if request.visual_preview_mode and product_resource == blank
              assign product_resource = collections.all.products.first
            endif
          -%}
          
          {% render 'variant-quick-add', product_resource: product_resource %}
        
        {% endif %} {% endcomment %}

        {% endunless %}
      
      
      {% if product %}
         {% content_for 'block', type: 'buy-buttons', id: 'buyButton' %}
      {% else %}
        <p>Loading product information...</p>
      {% endif %}
    </div>
  </div>
</quick-add-popup>

<style>
.quick-add-popup {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.quick-add-popup.hidden { display: none; }
.popup-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.6);
}
.popup-content {
  position: relative;
  background: #fff;
  max-width: 700px;
  width: 90%;
  padding: 24px;
  border-radius: 12px;
  z-index: 2;
  min-height: 400px;
  max-height: 500px;
  overflow-y: auto;
  overflow-x: hidden;
}
.popup-close {
  position: absolute;
    top: -40px;
    right: -40px;
    border: none;
    cursor: pointer;
    width: 44px;
    height: 44px;
    background: #D9D9D9;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 200px;
    color: #E90000;
}
.quick-add_product-variant-details {
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: 10px;
}
.quick-add-popup__content fieldset{
  border: none;
  padding: 0;
}
.variants-container{
  margin-bottom: 15px;
}
.variant-select-input{
  display: none;
}
.quick-add_product-variant-details label{
  cursor: pointer;
}
.variant-select-input:checked+label{
  border: 1px solid #ed1d23;
  border-radius: 7px;
}
.quick-add-popup__content h2{
  font-weight: 700;
  font-size: 24px;
  line-height: 28px;
}
.quick-add-popup__content .variant-picker__form{
  margin-bottom: 15px;
}
.quick-add-popup .variant-option__button-label:has(:checked){
  background: black;
}
.product_variant_item{
            display: flex;
            gap: 20px;
            background-color:  #fee9e9;
            border-radius: 8px;
            padding: 18px 22px;
        }
        .product_variant-image img{
            width: 77px;
            border-radius: 7px;;
        }
        .product_variant-title{
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .product-compare-price{
            text-decoration: line-through;
            color: #7F7474;
            font-weight: 600;
            font-size: 14px;
            line-height: 19.6px;
        }
        .product_variant-title p{
            font-weight: 500;
            font-size: 18px;
            line-height: 25.2px;
            margin: 0;
        }
        p.product_variant-name{
          font-weight: 700;
          font-size: 18px;
          line-height: 25.2px;
        }
        .product_variant-price{
          display: flex;
          align-items: center;
          gap: 24px;
        }
        .product_variant-price .product-price{
          font-weight: 600;
          font-size: 20px;
          line-height: 30px;
        }
        .product_variant-details span{
          font-weight: 600;
          font-size: 14px;
          line-height: 19.6px;
        }
        .product_variant-price-container{
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
</style>
