

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div class="section color-{{ section.settings.color_scheme }}">
  <div class="blog-content-wrapper">
    <div
      class="
        spacing-style
        layout-panel-flex
        layout-panel-flex--column
        section-content-wrapper
        mobile-column
      "
      style="
        {% render 'layout-panel-style', settings: section.settings %}
        {% render 'spacing-style', settings: section.settings %}
      "
    >
      <header>
        {%- content_for 'block', id: 'blog-post-title', type: 'text' %}
        {%- content_for 'block', id: 'blog-post-details', type: '_blog-post-info-text' %}
      </header>

      {%- if article.image -%}
        {%- content_for 'block', id: 'blog-post-image', type: '_blog-post-featured-image' %}
      {%- endif -%}
      {%- content_for 'block', id: 'blog-post-content', type: '_blog-post-content' %}

      {% comment %} Dynamic area for @app blocks only, at the bottom {% endcomment %}
      {% content_for 'blocks' %}

      {% if blog.comments_enabled? %}
        <div class="blog-post-comments-container">
          <h2 class="h3">{{- 'blogs.article.comments_heading' | t: count: article.comments_count -}}</h2>

          <div class="blog-post-comments">
            {% paginate article.comments by 10 %}
              {% for comment in article.comments %}
                <div class="blog-post-comment">
                  {{ comment.content }}
                  <div class="blog-post-comment__author">
                    <span class="blog-post-comment__author-name">{{- comment.author -}}</span>
                    <span>{{- 'blogs.article.comment_author_separator' | t -}}</span>
                    <span class="blog-post-comment__date">
                      {{- comment.created_at | time_tag: format: 'date' -}}
                    </span>
                  </div>
                </div>
              {% endfor %}

              <div class="blog-post-comments-pagination">
                {{- paginate | default_pagination -}}
              </div>
            {% endpaginate %}
          </div>

          {% render 'blog-comment-form', article: article, section_id: section.id %}
        </div>
      {% endif %}
    </div>
    <div class="blog-ingredients-block">
      <div class="blog-ingredients-content">
       <h4>Ingredient's </h4>
          <div class="blog-ingredient-products-list">
            {% assign products = article.metafields.custom.ingredient_products.value %}
            {% for product in products %}
              <div class="blog-ingredient-product-item">
                <div class="">
                  <div class="blog-ingredient-product-image-block">
                    {{ product.featured_image | image_url: width: 300 | image_tag : class: "blog-ingredient-product-image"  }}
                  </div>
                </div>
                <div class="blog-ingredient-product-info-block">
                  <h5>{{ product.title }}</h5>
                  <div class="blog-ingredient-product-info_details">
                    {% if product.metafields.custom.brand_name %}
                      <p>Brand: {{ product.metafields.custom.brand_name }}</p>
                    {% endif %}
                    <p>{{ product.selected_or_first_available_variant.sku }}</p>
                    {%unless product.selected_or_first_available_variant.available %}
                      <span class="blog-ingredient-product__soldout">Soldout</span>
                    {%endunless %}
                  </div>
                </div>
              </div>
            {% endfor %}
            <div class="buy-ingredients-button-wrapper">
                <button class="button button--primary blog-ingredients-button" id="add-all-ingredients"
                      data-products='[
                      {% for product in products %}
                        {% if product.selected_or_first_available_variant.available  %}
                          {"id": {{ product.selected_or_first_available_variant.id }}, "quantity": 1}
                          {% unless forloop.last %},{% endunless %}
                        {% endif %}
                      {% endfor %}
                      ]'>
                  BUY INGREDIENTâ€™S
                </button>
            </div>

            {% comment %} {% assign bundle_product = article.metafields.custom.bundle_product.value %}
            {%- liquid
                  assign product_variant_media = bundle_product.featured_media.preview_image | image_url: width: 100
                  if bundle_product.featured_media.preview_image != blank
                    assign product_variant_media = bundle_product.featured_media.preview_image | image_url: width: 100
                  endif
                -%}
                <div class="blog-ingredients-button-block">
                    <product-form-component
                        data-section-id="{{ section.id }}"
                        data-product-id="{{ bundle_product.selected_or_first_available_variant.id }}"
                        data-product-url="{{ bundle_product.url }}"
                        on:submit="/handleSubmit"
                        data-quantity-default="{% if bundle_product.selected_or_first_available_variant.quantity_rule.min %}{{ bundle_product.selected_or_first_available_variant.quantity_rule.min }}{% else %}1{% endif %}"
                      >
                        <div
                          class="visually-hidden"
                          aria-live="assertive"
                          role="status"
                          aria-atomic="true"
                          ref="liveRegion"
                        ></div>
                      {%- form 'product', bundle_product, data-type: 'add-to-cart-form' -%}
                      <input type="hidden" name="id" ref="variantId" value="{{ bundle_product.selected_or_first_available_variant.id }}">
                      <add-to-cart-component
                        ref="addToCartButtonContainer" 
                        data-product-variant-media="{{ product_variant_media }}"
                        data-add-to-cart-animation="true"
                        >
                        <button ref="addToCartButton"
                        class="button button--primary blog-ingredients-button" 
                        type="submit"
                        name="add"
                        on:click="/handleClick"
                        data-variant-id="{{ bundle_product.selected_or_first_available_variant.id }}">
                          BUY INGREDIENTâ€™S
                        </button>
                        
                      </add-to-cart-component>
                      
                    {% endform %}
                  </product-form-component>
                  {% comment %} <button class="blog-ingredients-button button button--primary">BUY INGREDIENTâ€™S</button> {% endcomment %}
                </div> {% endcomment %}
          </div>
      </div>
    </div>
  </div>
</div>

<script type="application/ld+json">
  {{ article | structured_data }}
</script>

<script type="module">
  import { CartAddEvent } from '@theme/events';

  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("add-all-ingredients");
    if (!btn) return;

    btn.addEventListener("click", () => {

      const items = JSON.parse(btn.dataset.products);

      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      })
      .then(res => res.json())
      .then(data => {

        // ðŸ”¥ Notify Horizon cart system
        document.dispatchEvent(new CartAddEvent(items));

        // ðŸ”¥ Open the cart popup (simulate click on cart icon)
        const cartTrigger = document.querySelector('[data-testid="cart-drawer-trigger"]');
        setTimeout(() => {
          if (cartTrigger) cartTrigger.click();
        }, 1000);
        

        console.log("Added all metafield products:", data);
      })
      .catch(err => console.error('Error:', err));

    });
  });
</script>



{% stylesheet %}
  .blog-post-comments-container {
    width: 100%;
    max-width: var(--normal-content-width);
    margin: 0 auto;
  }

  .blog-post-comments {
    display: flex;
    flex-direction: column;
    gap: var(--gap-3xl);
  }

  .blog-post-comment__author {
    display: flex;
    align-items: center;
    gap: var(--gap-2xs);
    margin-top: var(--margin-md);
    font-size: var(--font-size--body-sm);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-subdued-text));
  }

  .blog-post-comments-pagination {
    display: flex;
    justify-content: center;
    gap: var(--gap-2xs);
  }

  .blog-post-comments-pagination,
  .blog-post-comments-pagination a {
    color: var(--color-foreground);
  }

  .blog-post-comments-pagination .current {
    color: var(--color-foreground);
  }

  .blog-post-comments-pagination .current,
  .blog-post-comments-pagination a {
    display: block;
    padding: var(--padding-2xs) var(--padding-xs);
  }

  .blog-post-comments-pagination .current,
  .blog-post-comments-pagination a:hover {
    border-bottom: 1px solid var(--color-foreground);
  }

  .blog-ingredient-products-list{
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
  }
  .blog-ingredient-product-item{
    display: flex;
    gap: 23px;
  }
  .blog-ingredient-product-image-block{
    border: 1px solid #828282;
    border-radius: 8px;
  }
  .blog-ingredient-product-image{
    width: 92px;
    border-radius: 8px;
  }
  .blog-ingredient-product__soldout {
    border: 1px solid #000000;
    padding: 2px 10px;
    border-radius: 20px;
    color: #000000;
}
.blog-ingredient-product-image-block{
    width: 92px;
    height: 92px;
}
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.blog_post",
  "blocks": [
    {
      "type": "@theme"
    },
    {
      "type": "@app"
    }
  ],
  "class": "section-wrapper",
  "settings": [
    {
      "type": "select",
      "id": "content_direction",
      "label": "t:settings.direction",
      "options": [
        {
          "value": "column",
          "label": "t:options.vertical"
        }
      ],
      "default": "column",
      "visible_if": "{{ section.settings.gap < 0 }}"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "t:settings.gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": []
}
{% endschema %}
