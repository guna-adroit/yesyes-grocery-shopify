<style>
    /* import google font and fontawesome */
    @import url('https://fonts.googleapis.com/css?family=Roboto:500,100,300,700,400');
    @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css');
    *{
      margin: 0;
      padding: 0;
      font-family: roboto;
    }
    form#yesyes-review-form {
        max-width: 300px;
        border: 1px solid red;
        padding: 16px;
        border-radius: 10px;
        background: #f5f5f5;
    }

    div.stars{
      width: 270px;
      display: inline-block;
    }

    input.star{
      display: none;
    }

    .stars-wrapper {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-end;
    }
    #yesyes-reviews-list .stars-wrapper{
      flex-direction: row;
    }
    label.star {
      font-size: 36px;
      color: #FFCA27;
      transition: all .2s;
    }
    .stars-details label.star {
      font-size: 25px;
      padding: 0;
    }
    .reviews-header {
      display: flex;
      justify-content: space-between;
    }
    input.star:checked ~ label.star:before, label.star.filled:before, input.star:hover ~ label.star:before {
      content:'\f005';
      color: #FFCA27;
      transition: all .25s;
    }
    
    input.star-5:checked ~ label.star:before {
      color:#FFCA27;
      text-shadow: 0 0 20px #952;
    }

    input.star-1:checked ~ label.star:before {
      color: #F62;
    }

    label.star:hover{
      /* transform: rotate(144deg) scale(1.3); */
      color: #FFCA27;
    }

    label.star:before{
      content:'\f005';
      color: #BDBDBD;
      font-family: FontAwesome;
    }
    label.star.half-filled:before {
      color: #FFCA27;
      background: linear-gradient(to right, #FFCA27 50%, #BDBDBD 50%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .rev-box{
      overflow: hidden;
      height: 0;
      width: 100%;
      transition: all .25s;
      display: flex;  
      flex-direction: column;
      max-width: 260px;
      padding: 0 10px;
    }

    textarea.review{
      background: #222;
      border: none;
      width: 100%;
      max-width: 100%;
      height: 100px;
      padding: 10px;
      box-sizing: border-box;
      color: #EEE;
    }

    label.review{
      display: block;
      transition:opacity .25s;
    }
  
    element.style {
        display: flex;
        flex-direction: column;
        max-width: 300px;
        gap: 14px;
    }
    .review-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 400px;
        gap: 14px;
        padding: 24px 16px;
        margin-top: 18px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgb(0 0 0 / 10%);
    }
    div:has(input.star:checked) ~ .rev-box{
        height: 240px;
        overflow: visible;
        padding-top: 24px;
    }
    .review-form {
      margin-top: 36px;
      display: flex;
      flex-direction: column;
      width: 300px;
    }

    .review-form input, .review-form textarea {
      height: 54px;
      border-radius: 5px;
      background: white;
      margin-bottom: 15px;
      border: none;
      padding: 0 20px;
      font-weight: 300;
      font-size: 14px;
      color: #4B4B4B;
    }
    .review-form textarea{
      padding-top:15px;
    }

    .button_submit:hover, .review-form input:hover, .review-form textarea:hover {
      transform: scale(1.009);
      box-shadow: 0px 0px 3px 0px #212529;
    }

    .button_submit {
      width: 100%;
      height: 54px;
      font-size: 14px;
      color: white;
      background: red;
      border-radius: 5px;
      border: none;
      font-weight: 500;
      text-transform: uppercase;
    }
    #yesyes-reviews-list label.star {
        font-size: 18px;
        padding: 4px;
    }
    .user-info{
      font-family: Inter;
      font-weight: 600;
      font-size: 12px;
      line-height: 19.6px;
      letter-spacing: 0;

    }
    span.user-avatar {
        height: 55px;
        width: 55px;
        display: flex;
        background: #D9D9D9;
        border-radius: 50%;
    }
    .user-avatar::before {
      content: '';
      display: block;
      width: 50%;
      height: 50%;
      background-image: url(https://cdn.shopify.com/s/files/1/0979/1825/5185/files/user-icon.png?v=1770630235);
      position: relative;
      background-repeat: no-repeat;
      top: 25%;
      left: 25%;
    }
    p.comment-title {
        font-family: Inter;
        font-weight: 700;
        font-size: 18px;
        line-height: 25.2px;
        letter-spacing: 0;
    }
    p.comment-content {
        font-family: Inter;
        font-weight: 400;
        font-size: 16px;
        line-height: 21.4px;
        letter-spacing: 0;
    }
    .user-details {
        display: flex;
        align-items: center;
        gap: 13px;
    }
    .comment-title {
      font-weight: 600;
      margin: 8px 0 4px 0;
    }
    div#yesyes-reviews-list {
        display: flex;
        gap: 16px;
        padding-top: 20px;
        flex-direction: column;
    }
    .yesyes-review {
      padding: 10px;
      border-radius: 8px;
    }
    .user {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      flex-direction: column;
    }
    .stars-details {
        display: flex;
        flex-direction: column;
    }
    .reviews-count p {
        font-family: Inter;
        font-weight: 600;
        font-size: 20px;
        line-height: 30px;
        letter-spacing: 0;
    }
    .review-section-wrapper {
        display: flex;
        width: 100%;
        justify-content: space-between;
        gap: 10%;
    }
    .reviews-section {
        flex: 0 0 60%;
    }
    .section-stars-wrapper {
        flex: 0 0 25%;
    }
    h2.yesyes-heading {
        font-family: Inter;
        font-weight: 700;
        font-size: 34px;
        line-height: 44px;
        letter-spacing: 0;
    }
    .average-stars {
      padding-top: 30px;
      display: flex;
      align-items: center;
      gap: 30px;
      font-family: Inter;
      font-weight: 500;
      font-size: 20px;
      line-height: 28px;
      letter-spacing: 0;

    }
    div#total-reviews {
        font-family: Inter;
        font-weight: 700;
        font-size: 18px;
        line-height: 25.2px;
        letter-spacing: 0;
        padding: 20px 0;
    }
    span.count-label, .count-percentage {
        font-family: Inter;
        font-weight: 600;
        font-size: 14px;
        line-height: 19.6px;
        letter-spacing: 0;
    }
    .count-label{
      margin-right: 13px;
    }
    .count-percentage {
      margin-left: 17px;
    }
    .star-single {
        display: flex;
        align-items: center;
    }
    #view-all-reviews{
      margin-top: 24px;
    }
    select#review-filter, .review-wrapper {
      display: none;
    }
    select#review-sort {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #000000;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 700;
        padding: 10px;
        background-color: #feefef;
        border: 1px solid #e5d8d8;
    }
    option {
      padding: 10px;
      border-top: 1px solid  rgb(127, 8, 8);
      cursor: pointer;
      transition-property: color, background;
      transition-duration: 0.2s;
      transition-timing-function: ease-out;
      &:where(:hover, :focus, :active) {
        background: rgb(192, 142, 142);
        color: white;
    }
    &:checked {
      background: #e50914;
      color: white;
    }
    &::checkmark {
      /* display: none; */
    }
    &:first-child {
      border: 0;
    }
}
@media screen and (max-width: 768px) {
  .review-section-wrapper {
    flex-direction: column;
    gap: 30px;
  }
  .reviews-header {
    flex-direction: column;
    gap: 16px;
  }
}
</style>

{% assign full_width = false %}

{% if section.settings.width_percent == 100 and section.settings.section_width == 'full-width' %}
  {% assign full_width = true %}
{% endif %}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="section section--{{ section.settings.section_width }} color-{{ section.settings.color_scheme }}" style="padding-top: {{ section.settings.padding-block-start }}px; padding-bottom: {{ section.settings.padding-block-end }}px;"
> <span style="opacity: 0;">
  {% render 'divider', id: section.id, settings: section.settings, attributes: true, full_width: full_width %}
  </span>

{% comment %}
  YesYes Reviews – Core Section
  Secure integration via Shopify App Proxy
{% endcomment %}

<section id="yesyes-reviews"
  data-product-id="gid://shopify/Product/{{ product.id }}"
  {% comment %} Test Data:
                Maya: 23983640543313
                Sree: 23979636457553
                Praveen: 23852944097361
  {% endcomment %}
  data-customer-id="{% if customer %}gid://shopify/Customer/23979636457553{% endif %}"
>
<div class="review-section-wrapper">
<div class="section-stars-wrapper">
  <h2 class="yesyes-heading">Customer Reviews</h2>
  <div class="average-stars">
    <div id="average-stars">
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
    </div>
    <div id="average-rating">
      5 out of 5
    </div>
  </div>
  <div id="total-reviews">
    0 Ratings
  </div>
  <div class="stars-details">
    <span class="star-single" id="rating-5">
      <span class="count-label">5 Star</span>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <span class="count-percentage">0%</span>
    </span>
    <span class="star-single" id="rating-4">
      <span class="count-label">4 Star</span>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star"></label>
      <span class="count-percentage">0%</span>
    </span>
    <span class="star-single" id="rating-3">
      <span class="count-label">3 Star</span>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star"></label>
      <label class="star"></label>
      <span class="count-percentage">0%</span>
    </span>
    <span class="star-single" id="rating-2">
      <span class="count-label">2 Star</span>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star"></label>
      <label class="star"></label>
      <label class="star"></label>
      <span class="count-percentage">0%</span>
    </span>
    <span class="star-single" id="rating-1">
      <span class="count-label">1 Star</span>
      <label class="star filled"></label>
      <label class="star"></label>
      <label class="star"></label>
      <label class="star"></label>
      <label class="star"></label>
      <span class="count-percentage">0%</span>
    </span>
  </div>
</div>
  <!-- Reviews List -->
  <div class="reviews-section">
    <div class="reviews-header">
      <div class="reviews-count">
        <p id="reviews-count">0 Customer Reviews</p>
      </div>
      {% if template.suffix == 'reviews' %}
        <div class="review-controls">
            <select id="review-sort">
              <option value="latest">Latest</option>
              <option value="oldest">Oldest</option>
              <option value="rating-high">Rating: High to Low</option>
              <option value="rating-low">Rating: Low to High</option>
            </select>
            <select id="review-filter">
              <option value="all">All Ratings</option>
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
            </select> 
        </div>
      {% endif %}
    </div>
    <div id="yesyes-reviews-list">
      <p>Loading reviews...</p>
    </div>
    {% if template.name == 'product' %}
      <div class="view-all-wrapper {{ template.suffix }}">
        <a id="view-all-reviews" 
        class="size-style section_view_all button"
        href="/pages/reviews?product={{ product.id }}">
          View More Comments
        </a>
      </div>
    {% endif %}
  </div>
</div>
  <!-- Review Form -->
   <div class="review-wrapper">
    <div id="yesyes-review-status" class="review-status" hidden></div>
     {% if customer %}
      <h4 class="review-heading">Share your thoughts </h4>
      <p class="review-product-title"> {{ product.title }}</p>
      <hr style="width: 100%; border: 1px solid #ccc;" />
        <form id="yesyes-review-form" class="review-form">
          <div class="stars-wrapper">
            <input name="rating" class="star" id="star-5-2" type="radio" value="5" required  />
            <label class="star" for="star-5-2"></label>

            <input name="rating" class="star" id="star-4-2" type="radio" value="4" />
            <label class="star" for="star-4-2"></label>

            <input name="rating" class="star" id="star-3-2" type="radio" value="3" />
            <label class="star" for="star-3-2"></label>

            <input name="rating" class="star" id="star-2-2" type="radio" value="2" />
            <label class="star" for="star-2-2"></label>

            <input name="rating" class="star" id="star-1-2" type="radio" value="1" />
            <label class="star" for="star-1-2"></label>
          </div>
          <div class="rev-box">
            <input type="text" name="title" placeholder="Review Title" required />
            <textarea rows="20" name="body" placeholder="Write a review" required></textarea>
            <button class="button_submit">Submit Review</button>
          </div>
        </form>

      {% else %}
        <p>
          <a href="/account/login">Log in to write a review</a>
        </p>
      {% endif %}
    </div>
</section>
</div>
<script>
(function () {
  const section = document.getElementById('yesyes-reviews');
  if (!section) return;

  //extract id from pageurl
  idValue = new URLSearchParams(window.location.search).get('product');
  if (location.pathname === '/pages/reviews') {
    var isReviewsPage = true;
    var productId = idValue ? `gid://shopify/Product/${idValue}` : null;
    console.log('Product ID from URL:', productId );
  }
  else {
    var isReviewsPage = false;
    var productId = section.dataset.productId;
    console.log('Product ID from PDP:', productId );

  }
  const customerId = "{% if customer %}{{ customer.id }}{% else %}000{% endif %}";
  const reviewerName = "{% if customer %}{{ customer.first_name }}{% else %}Guest{% endif %}";
  console.log('productId ID:', productId);

  const listEl = document.getElementById('yesyes-reviews-list');
  const formEl = document.getElementById('yesyes-review-form');
  const statusEl = document.getElementById('yesyes-review-status');

  const BASE = 'https://yesyes-grocerz.myshopify.com/apps/reviews';


/* -----------------------------
   FETCH REVIEWS + SORT + FILTER
----------------------------- */

let ALL_REVIEWS = [];
let CURRENT_REVIEWS = [];

const SORT_STATE = {
  sort: 'latest',     // latest | oldest | rating-high | rating-low
  filter: 'all'       // all | 5 | 4 | 3 | 2 | 1
};

/* ---------- Render ---------- */
if (isReviewsPage) {
  var MAX_PDP_REVIEWS = 250;
}
else {
  var MAX_PDP_REVIEWS = 2;
}
function renderReviews(reviews) {
  if (!reviews.length) {
    listEl.innerHTML = '<p>No reviews found.</p>';
    return;
  }
// limit with 2

  const limitedReviews = reviews.slice(0, MAX_PDP_REVIEWS);
  listEl.innerHTML = limitedReviews.map(r => `
    <div class="yesyes-review"
      data-rating="${r.rating}"
      data-created="${r.createdAt}"
    >
      <div class="user">
        <div class="user-details">
          <span class="user-avatar"></span>
          <span class="user-info">${r.reviewerName || 'User'}</span>
        </div>
        <div class="stars-wrapper">
          ${'<label class="star filled"></label>'.repeat(r.rating)}
          ${'<label class="star"></label>'.repeat(5 - r.rating)}
        </div>
      </div>
      <div class="comment-rating">
        <p class="comment-title">${r.title}</p>
        <p class="comment-content">${r.body}</p>
      </div>
    </div>
  `).join('');
}

/* ---------- Apply Sort & Filter ---------- */
function applySortAndFilter() {
  let result = [...ALL_REVIEWS];

  /* ---- Filter by stars ---- */
  if (SORT_STATE.filter !== 'all') {
    result = result.filter(r => r.rating === Number(SORT_STATE.filter));
  }

  /* ---- Sort ---- */
  switch (SORT_STATE.sort) {
    case 'latest':
      result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      break;

    case 'oldest':
      result.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
      break;

    case 'rating-high':
      result.sort((a, b) => b.rating - a.rating);
      break;

    case 'rating-low':
      result.sort((a, b) => a.rating - b.rating);
      break;
  }

  CURRENT_REVIEWS = result;
  renderReviews(CURRENT_REVIEWS);
}

/* ---------- Fetch ---------- */
fetch(`${BASE}/api/v1/product-reviews/integration/reviews/fetch`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ productId })
})
.then(res => res.json())
.then(data => {
  console.log('Reviews data:', data);

  ALL_REVIEWS = data?.reviews || [];
  applySortAndFilter(); // default sort + render
  console.log('Reviews data:', data);

  ALL_REVIEWS = data.reviews || [];
  CURRENT_REVIEWS = [...ALL_REVIEWS];

  renderRatingSummaryFromAPI(data);
  renderReviews(CURRENT_REVIEWS);
})
.catch(() => {
  listEl.innerHTML = '<p>Unable to load reviews.</p>';
});

document.getElementById('review-sort').addEventListener('change', e => {
  SORT_STATE.sort = e.target.value;
  applySortAndFilter();
});

document.getElementById('review-filter').addEventListener('change', e => {
  SORT_STATE.filter = e.target.value;
  applySortAndFilter();
});


  /* -----------------------------
     READY CHECK
  ----------------------------- */
  if (!formEl) return;

  fetch(`${BASE}/api/v1/product-reviews/integration/reviews/ready`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ productId, customerId })
  })
  .then(res => res.json())
  .then(data => {
    console.log('Ready data:', data);
    if (!data.eligible) {
      formEl.style.display = 'none';
      statusEl.hidden = false;
      statusEl.innerHTML = '<p>You are not eligible to review this product.</p>';
      return;
    }

    // Eligible
    statusEl.hidden = true;
    formEl.style.display = 'block';

    // Existing review → prefill
    if (data.review) {
      const r = data.review;

      const ratingInput = formEl.querySelector(
        `input[name="rating"][value="${r.rating}"]`
      );
      if (ratingInput) ratingInput.checked = true;

      formEl.title.value = r.title || '';
      formEl.body.value = r.body || '';
    }
  })
  .catch(() => {
    formEl.style.display = 'none';
    statusEl.hidden = false;
    statusEl.innerHTML = '<p>Unable to check review eligibility.</p>';
  });


  /* -----------------------------
     RATING SUMMARY RENDER
  ----------------------------- */

  function renderRatingSummaryFromAPI(data) {
  const total = data.totalReviews || 0;
  const dist = data.ratingDistribution || {};

  /* ---------- Total ---------- */
  document.getElementById('total-reviews').innerText =
    `${total} Ratings`;
  document.getElementById('reviews-count').innerText =
    `${total} Customer Reviews`;

  if (!total) {
    document.getElementById('average-rating').innerText = '0 out of 5';
    return;
  }

  /* ---------- Average ---------- */
  let sum = 0;
  for (let i = 1; i <= 5; i++) {
    sum += (dist[i] || 0) * i;
  }

  const avg = (sum / total).toFixed(1);
  document.getElementById('average-rating').innerText =
    `${avg} out of 5`;

  /* ---------- Fill average stars ---------- */
  const avgStars = document.querySelectorAll('#average-stars .star');

  avgStars.forEach((star, idx) => {
    const starValue = idx + 1;

    star.classList.remove('filled', 'half-filled');

    if (avg >= starValue) {
      star.classList.add('filled');
    } else if (avg >= starValue - 0.5) {
      star.classList.add('half-filled');
    }
  });

  /* ---------- Distribution ---------- */
  for (let i = 1; i <= 5; i++) {
    const count = dist[i] || 0;
    const percent = Math.round((count / total) * 100);

    const row = document.getElementById(`rating-${i}`);
    if (!row) continue;

    row.querySelector('.count-percentage').innerText = `${percent}%`;

    const stars = row.querySelectorAll('.star');
    stars.forEach((star, idx) => {
      star.classList.toggle('filled', idx < i);
    });
  }
}

  /* -----------------------------
     SUBMIT REVIEW
  ----------------------------- */
  formEl.addEventListener('submit', function (e) {
    e.preventDefault();

    if (!formEl.rating.value) {
      alert('Please select a rating');
      return;
    }

    const payload = {
      productId,
      customerId,
      reviewerName,
      rating: Number(formEl.rating.value),
      title: formEl.title.value,
      body: formEl.body.value
    };

    const btn = formEl.querySelector('.button_submit');
    btn.disabled = true;

    fetch(`${BASE}/api/v1/product-reviews/integration/reviews`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (!res.ok) throw new Error();
      location.reload();
    })
    .catch(() => {
      btn.disabled = false;
      alert('Failed to submit review');
    });
  });

})();

</script>



{% schema %}
{
  "name": "Reviews",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "page-width",
          "label": "t:options.page"
        },
        {
          "value": "full-width",
          "label": "t:options.full"
        }
      ],
      "default": "full-width"
    },
    {
      "type": "range",
      "id": "thickness",
      "label": "t:settings.thickness",
      "min": 0.5,
      "max": 5,
      "step": 0.5,
      "unit": "px",
      "default": 1
    },
    {
      "type": "select",
      "id": "corner_radius",
      "label": "t:settings.border_radius",
      "options": [
        {
          "value": "square",
          "label": "t:options.square"
        },
        {
          "value": "rounded",
          "label": "t:options.rounded"
        }
      ],
      "default": "square",
      "visible_if": "{{ section.settings.thickness > 1 and section.settings.width_percent != 100 or section.settings.section_width == \"page-width\"}}"
    },
    {
      "type": "range",
      "id": "width_percent",
      "label": "t:settings.length",
      "min": 5,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100
    },
    {
      "type": "select",
      "id": "alignment_horizontal",
      "label": "t:settings.alignment",
      "options": [
        {
          "value": "flex-start",
          "label": "t:options.left"
        },
        {
          "value": "center",
          "label": "t:options.center"
        },
        {
          "value": "flex-end",
          "label": "t:options.right"
        }
      ],
      "default": "center",
      "visible_if": "{{ section.settings.width_percent < 100 }}"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 16
    }
  ],
  "presets": [
    {
      "name": "Reviews",
      "category": "t:categories.layout"
    }
  ]
}
{% endschema %}
