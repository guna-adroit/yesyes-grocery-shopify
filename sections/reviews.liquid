<style>
    
</style>

{% assign full_width = false %}

{% if section.settings.width_percent == 100 and section.settings.section_width == 'full-width' %}
  {% assign full_width = true %}
{% endif %}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="section section--{{ section.settings.section_width }} color-{{ section.settings.color_scheme }}" style="padding-top: {{ section.settings.padding-block-start }}px; padding-bottom: {{ section.settings.padding-block-end }}px;"
> <span style="opacity: 0;">
  {% render 'divider', id: section.id, settings: section.settings, attributes: true, full_width: full_width %}
  </span>

{% comment %}
  YesYes Reviews – Core Section
  Secure integration via Shopify App Proxy
{% endcomment %}

<section id="yesyes-reviews"
  data-product-id="gid://shopify/Product/{{ product.id }}"
  {% comment %} Test Data:
                Maya: 23983640543313
                Sree: 23979636457553
                Praveen: 23852944097361
  {% endcomment %}
  data-customer-id="{% if customer %}gid://shopify/Customer/23979636457553{% endif %}"
>
<div class="review-section-wrapper">
<div class="section-stars-wrapper">
  <h2 class="yesyes-heading">Customer Reviews</h2>
  {% if customer %}
    <p id="write-review" class="write-review">Write a Review</p>
  {% endif %}
  <div class="average-stars">
    <div id="average-stars">
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
    </div>
    <div id="average-rating">
      5 out of 5
    </div>
  </div>
  <div id="total-reviews">
    0 Ratings
  </div>
  <div class="stars-details">
    <span class="star-single" id="rating-5">
      <span class="count-label">5 Star</span>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <span class="count-percentage">0%</span>
    </span>
    <span class="star-single" id="rating-4">
      <span class="count-label">4 Star</span>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star"></label>
      <span class="count-percentage">0%</span>
    </span>
    <span class="star-single" id="rating-3">
      <span class="count-label">3 Star</span>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star"></label>
      <label class="star"></label>
      <span class="count-percentage">0%</span>
    </span>
    <span class="star-single" id="rating-2">
      <span class="count-label">2 Star</span>
      <label class="star filled"></label>
      <label class="star filled"></label>
      <label class="star"></label>
      <label class="star"></label>
      <label class="star"></label>
      <span class="count-percentage">0%</span>
    </span>
    <span class="star-single" id="rating-1">
      <span class="count-label">1 Star</span>
      <label class="star filled"></label>
      <label class="star"></label>
      <label class="star"></label>
      <label class="star"></label>
      <label class="star"></label>
      <span class="count-percentage">0%</span>
    </span>
  </div>
</div>
  <!-- Reviews List -->
  <div class="reviews-section">
    <div class="reviews-header">
      <div class="reviews-count">
        <p id="reviews-count">0 Customer Reviews</p>
      </div>
      {% if template.suffix == 'reviews' %}
        <div class="review-controls">
            <select id="review-sort">
              <option value="latest">Latest</option>
              <option value="oldest">Oldest</option>
              <option value="rating-high">Rating: High to Low</option>
              <option value="rating-low">Rating: Low to High</option>
            </select>
            <select id="review-filter">
              <option value="all">All Ratings</option>
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
            </select> 
        </div>
      {% endif %}
    </div>
    <div id="yesyes-reviews-list">
      <p>Loading reviews...</p>
    </div>
    {% if template.name == 'product' %}
      <div class="view-all-wrapper {{ template.suffix }}">
        <a id="view-all-reviews" 
        class="size-style section_view_all button"
        href="/pages/reviews?product={{ product.id }}">
          View More Comments
        </a>
      </div>
    {% endif %}
  </div>
</div>
  <!-- Review Form -->
   <div class="review-wrapper-bg">
    <div class="review-wrapper">
      <div id="yesyes-review-status" class="review-status" hidden></div>
      {% if customer %}
        <h4 class="review-heading">Share your thoughts </h4>
        <p class="review-product-title"> {{ product.title }}</p>
        <hr style="width: 100%;border: 1px solid #ccc;margin-top: 0px;" />
          <form id="yesyes-review-form" class="review-form">
            <span class="review-label">Rate your experience <span class="mandatory-star">*</span></span>
            <div class="stars-wrapper">
              <input name="rating" class="star" id="star-5-2" type="radio" value="5" required  />
              <label class="star" for="star-5-2"></label>

              <input name="rating" class="star" id="star-4-2" type="radio" value="4" />
              <label class="star" for="star-4-2"></label>

              <input name="rating" class="star" id="star-3-2" type="radio" value="3" />
              <label class="star" for="star-3-2"></label>

              <input name="rating" class="star" id="star-2-2" type="radio" value="2" />
              <label class="star" for="star-2-2"></label>

              <input name="rating" class="star" id="star-1-2" type="radio" value="1" />
              <label class="star" for="star-1-2"></label>
            </div>
            <div class="rev-box">
              <span class="review-label">Review Title <span class="mandatory-star">*</span></span>
              <input type="text" name="title" placeholder="Review Title" required />
              <span class="review-label">Write a review <span class="mandatory-star">*</span></span>
              <textarea rows="4" name="body" placeholder="Write a review" required></textarea>
              <button class="button_submit">Submit Review</button>
            </div>
          </form>

        {% else %}
          <p>
            <a href="/account/login">Log in to write a review</a>
          </p>
        {% endif %}
    </div>
  </div>
</section>
</div>
<script>
(function () {
  const section = document.getElementById('yesyes-reviews');
  if (!section) return;

  //extract id from pageurl
  idValue = new URLSearchParams(window.location.search).get('product');
  if (location.pathname === '/pages/reviews') {
    var isReviewsPage = true;
    var productId = idValue ? `gid://shopify/Product/${idValue}` : null;
    console.log('Product ID from URL:', productId );
  }
  else {
    var isReviewsPage = false;
    var productId = section.dataset.productId;
    console.log('Product ID from PDP:', productId );

  }
  const customerId = "{% if customer %}{{ customer.id }}{% else %}000{% endif %}";
  const reviewerName = "{% if customer %}{{ customer.first_name }}{% else %}Guest{% endif %}";
  console.log('productId ID:', productId);

  const listEl = document.getElementById('yesyes-reviews-list');
  const formEl = document.getElementById('yesyes-review-form');
  const statusEl = document.getElementById('yesyes-review-status');

  const BASE = 'https://yesyes-grocerz.myshopify.com/apps/reviews';


/* -----------------------------
   FETCH REVIEWS + SORT + FILTER
----------------------------- */

let ALL_REVIEWS = [];
let CURRENT_REVIEWS = [];

const SORT_STATE = {
  sort: 'latest',     // latest | oldest | rating-high | rating-low
  filter: 'all'       // all | 5 | 4 | 3 | 2 | 1
};

/* ---------- Render ---------- */
if (isReviewsPage) {
  var MAX_PDP_REVIEWS = 250;
}
else {
  var MAX_PDP_REVIEWS = 2;
}
function renderReviews(reviews) {
  if (!reviews.length) {
    listEl.innerHTML = '<p>No reviews found.</p>';
    return;
  }
// limit with 2

  const limitedReviews = reviews.slice(0, MAX_PDP_REVIEWS);
  listEl.innerHTML = limitedReviews.map(r => `
    <div class="yesyes-review"
      data-rating="${r.rating}"
      data-created="${r.createdAt}"
    >
      <div class="user">
        <div class="user-details">
          <span class="user-avatar"></span>
          <span class="user-info">${r.reviewerName || 'User'}</span>
        </div>
        <div class="stars-wrapper">
          ${'<label class="star filled"></label>'.repeat(r.rating)}
          ${'<label class="star"></label>'.repeat(5 - r.rating)}
        </div>
      </div>
      <div class="comment-rating">
        <p class="comment-title">${r.title}</p>
        <p class="comment-content">${r.body}</p>
      </div>
    </div>
  `).join('');
}

/* ---------- Apply Sort & Filter ---------- */
function applySortAndFilter() {
  let result = [...ALL_REVIEWS];

  /* ---- Filter by stars ---- */
  if (SORT_STATE.filter !== 'all') {
    result = result.filter(r => r.rating === Number(SORT_STATE.filter));
  }

  /* ---- Sort ---- */
  switch (SORT_STATE.sort) {
    case 'latest':
      result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      break;

    case 'oldest':
      result.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
      break;

    case 'rating-high':
      result.sort((a, b) => b.rating - a.rating);
      break;

    case 'rating-low':
      result.sort((a, b) => a.rating - b.rating);
      break;
  }

  CURRENT_REVIEWS = result;
  renderReviews(CURRENT_REVIEWS);
}
  /* -----------------------------
     Open review modal on "Write a Review" click
  ----------------------------- */
  
  const writeReviewEl = document.getElementById('write-review');
  if (writeReviewEl) {
    writeReviewEl.addEventListener('click', () => {
      formEl.style.display = 'block';
      statusEl.hidden = true;
      document.querySelector('.review-wrapper-bg').classList.add('active');
    });
    // close modal on outside click
    document.querySelector('.review-wrapper-bg').addEventListener('click', (e) => {
      if (e.target.classList.contains('review-wrapper-bg')) {
        e.target.classList.remove('active');
      }
    });
  }
  
/* ---------- Fetch ---------- */
fetch(`${BASE}/api/v1/product-reviews/integration/reviews/fetch`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ productId })
})
.then(res => res.json())
.then(data => {
  console.log('Reviews data:', data);

  ALL_REVIEWS = data?.reviews || [];
  applySortAndFilter(); // default sort + render
  console.log('Reviews data:', data);

  ALL_REVIEWS = data.reviews || [];
  CURRENT_REVIEWS = [...ALL_REVIEWS];

  renderRatingSummaryFromAPI(data);
  renderReviews(CURRENT_REVIEWS);
})
.catch(() => {
  listEl.innerHTML = '<p>Unable to load reviews.</p>';
});

  // if on reviews page, show filter and sort options
  if (isReviewsPage) {
    document.getElementById('review-sort').addEventListener('change', e => {
      SORT_STATE.sort = e.target.value;
      applySortAndFilter();
    });

    document.getElementById('review-filter').addEventListener('change', e => {
      SORT_STATE.filter = e.target.value;
      applySortAndFilter();
    });
  }

  /* -----------------------------
     READY CHECK
  ----------------------------- */
  if (!formEl) return;

  fetch(`${BASE}/api/v1/product-reviews/integration/reviews/ready`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ productId, customerId })
  })
  .then(res => res.json())
  .then(data => {
    console.log('Ready data:', data);
    if (!data.eligible) {
      formEl.style.display = 'none';
      document.getElementById('write-review').style.display = 'none';
      statusEl.hidden = false;
      statusEl.innerHTML = '<p>You are not eligible to review this product.</p>';
      return;
    }

    // Eligible
    statusEl.hidden = true;
    formEl.style.display = 'block';

    // Existing review → prefill
    if (data.review) {
      const r = data.review;

      const ratingInput = formEl.querySelector(
        `input[name="rating"][value="${r.rating}"]`
      );
      if (ratingInput) ratingInput.checked = true;

      formEl.title.value = r.title || '';
      formEl.body.value = r.body || '';
    }
  })
  .catch(() => {
    formEl.style.display = 'none';
    statusEl.hidden = false;
    statusEl.innerHTML = '<p>Unable to check review eligibility.</p>';
  });


  /* -----------------------------
     RATING SUMMARY RENDER
  ----------------------------- */

  function renderRatingSummaryFromAPI(data) {
  const total = data.totalReviews || 0;
  const dist = data.ratingDistribution || {};

  /* ---------- Total ---------- */
  document.getElementById('total-reviews').innerText =
    `${total} Ratings`;
  document.getElementById('reviews-count').innerText =
    `${total} Customer Reviews`;

  if (!total) {
    document.getElementById('average-rating').innerText = '0 out of 5';
    return;
  }

  /* ---------- Average ---------- */
  let sum = 0;
  for (let i = 1; i <= 5; i++) {
    sum += (dist[i] || 0) * i;
  }

  const avg = (sum / total).toFixed(1);
  document.getElementById('average-rating').innerText =
    `${avg} out of 5`;

  /* ---------- Fill average stars ---------- */
  const avgStars = document.querySelectorAll('#average-stars .star');

  avgStars.forEach((star, idx) => {
    const starValue = idx + 1;

    star.classList.remove('filled', 'half-filled');

    if (avg >= starValue) {
      star.classList.add('filled');
    } else if (avg >= starValue - 0.5) {
      star.classList.add('half-filled');
    }
  });

  /* ---------- Distribution ---------- */
  for (let i = 1; i <= 5; i++) {
    const count = dist[i] || 0;
    const percent = Math.round((count / total) * 100);

    const row = document.getElementById(`rating-${i}`);
    if (!row) continue;

    row.querySelector('.count-percentage').innerText = `${percent}%`;

    const stars = row.querySelectorAll('.star');
    stars.forEach((star, idx) => {
      star.classList.toggle('filled', idx < i);
    });
  }
}

  /* -----------------------------
     SUBMIT REVIEW
  ----------------------------- */
  formEl.addEventListener('submit', function (e) {
    e.preventDefault();

    if (!formEl.rating.value) {
      alert('Please select a rating');
      return;
    }

    const payload = {
      productId,
      customerId,
      reviewerName,
      rating: Number(formEl.rating.value),
      title: formEl.title.value,
      body: formEl.body.value
    };

    const btn = formEl.querySelector('.button_submit');
    btn.disabled = true;

    fetch(`${BASE}/api/v1/product-reviews/integration/reviews`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (!res.ok) throw new Error();
      location.reload();
    })
    .catch(() => {
      btn.disabled = false;
      alert('Failed to submit review');
    });
  });

})();

</script>



{% schema %}
{
  "name": "Reviews",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "page-width",
          "label": "t:options.page"
        },
        {
          "value": "full-width",
          "label": "t:options.full"
        }
      ],
      "default": "full-width"
    },
    {
      "type": "range",
      "id": "thickness",
      "label": "t:settings.thickness",
      "min": 0.5,
      "max": 5,
      "step": 0.5,
      "unit": "px",
      "default": 1
    },
    {
      "type": "select",
      "id": "corner_radius",
      "label": "t:settings.border_radius",
      "options": [
        {
          "value": "square",
          "label": "t:options.square"
        },
        {
          "value": "rounded",
          "label": "t:options.rounded"
        }
      ],
      "default": "square",
      "visible_if": "{{ section.settings.thickness > 1 and section.settings.width_percent != 100 or section.settings.section_width == \"page-width\"}}"
    },
    {
      "type": "range",
      "id": "width_percent",
      "label": "t:settings.length",
      "min": 5,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100
    },
    {
      "type": "select",
      "id": "alignment_horizontal",
      "label": "t:settings.alignment",
      "options": [
        {
          "value": "flex-start",
          "label": "t:options.left"
        },
        {
          "value": "center",
          "label": "t:options.center"
        },
        {
          "value": "flex-end",
          "label": "t:options.right"
        }
      ],
      "default": "center",
      "visible_if": "{{ section.settings.width_percent < 100 }}"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 16
    }
  ],
  "presets": [
    {
      "name": "Reviews",
      "category": "t:categories.layout"
    }
  ]
}
{% endschema %}
