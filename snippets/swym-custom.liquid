<script>
function refreshCartFromSwym(eventData) {
  // Find all cart section components
  const cartSections = document.querySelectorAll('cart-items-component');

  cartSections.forEach((section) => {
    const sectionId = section.dataset.sectionId;
    if (!sectionId) return;

    // Prepare formData to mimic theme's add-to-cart flow
    const formData = new FormData();
    formData.append('sections', sectionId);
    formData.append('sections_url', window.location.pathname);

    fetch('/cart/add.js', {
      method: 'POST',
      body: formData,
    })
      .then((res) => res.json())
      .then((response) => {
        // Dispatch the cart update event so theme handles UI
        const itemCount = eventData?.itemCount || 1;
        const productId = eventData?.productId || '';
        document.dispatchEvent(
          new CustomEvent('cart:refresh', {
            detail: {
              itemCount,
              productId,
            },
          })
        );

        // Trigger Shopify cart sections update (like theme AddToCartComponent)
        section.dispatchEvent(
          new CustomEvent('cart:update', { detail: response })
        );
      })
      .catch((err) => console.error('Swym cart refresh failed:', err));
  });
}

function onSwymLoadCallback(swat) {
  swat.evtLayer.addEventListener(swat.JSEvents.UIAddedToCart, function(evt) {
    refreshCartFromSwym(evt.detail);
  });

  swat.evtLayer.addEventListener(swat.JSEvents.UIAddedAllToCart, function(evt) {
    refreshCartFromSwym(evt.detail);
  });
}

if (!window.SwymCallbacks) {
  window.SwymCallbacks = [];
}
window.SwymCallbacks.push(onSwymLoadCallback);
</script>
