<script>
function onSwymLoadCallback(swat) {
  /**
   * Fetch current cart and dispatch Horizons cart update
   * @param {Object} detail - Swym event detail
   */
  async function handleCartRefresh(detail) {
    try {
      // Fetch the updated cart JSON
      const response = await fetch('/cart.js');
      const cart = await response.json();

      // Dispatch the CartUpdateEvent the Horizon theme listens for
      const event = new CartUpdateEvent(cart, 'swym-wishlist', {
        itemCount: cart.item_count,
        source: 'swym',
        sections: cart.sections || {}
      });
      document.dispatchEvent(event);

      // Optionally open the cart drawer
      const cartDrawer = document.querySelector('cart-drawer-component');
      if (cartDrawer) {
        cartDrawer.open = true;
      }
    } catch (err) {
      console.error('Horizon cart refresh error:', err);
    }
  }

  // Listen for a single “add to cart” from Swym
  swat.evtLayer.addEventListener(swat.JSEvents.UIAddedToCart, evt => {
    handleCartRefresh(evt.detail);
  });

  // Listen for move‑all/add‑all events (SFL)
  swat.evtLayer.addEventListener(swat.JSEvents.UIAddedAllToCart, evt => {
    handleCartRefresh(evt.detail);
  });
}

if (!window.SwymCallbacks) {
  window.SwymCallbacks = [];
}
window.SwymCallbacks.push(onSwymLoadCallback);
</script>
