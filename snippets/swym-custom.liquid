<script type="module">
import { CartUpdateEvent } from '@theme/events';

function onSwymLoadCallback(swat) {

  async function updateHorizonCart() {
    try {
      // 1️⃣ Fetch the updated cart
      const cartResponse = await fetch('/cart.js');
      const cart = await cartResponse.json();

      // 2️⃣ Dispatch Horizon's CartUpdateEvent
      const cartUpdateEvt = new CartUpdateEvent(cart, 'swym-wishlist', {
        itemCount: cart.item_count,
        source: 'swym',
        sections: {} // optional
      });
      document.dispatchEvent(cartUpdateEvt);

      // 3️⃣ Update cart drawer content using Shopify section rendering
      const drawerSectionsResponse = await fetch(`${routes.cart_url}?sections=cart-drawer`);
      const sectionsHtml = await drawerSectionsResponse.json();

      // Replace existing cart drawer with fresh HTML
      const parser = new DOMParser();
      const doc = parser.parseFromString(sectionsHtml['cart-drawer'], 'text/html');
      const newDrawer = doc.querySelector('cart-drawer');
      const currentDrawer = document.querySelector('cart-drawer');
      if (newDrawer && currentDrawer) {
        currentDrawer.replaceWith(newDrawer);
      }

      // 4️⃣ Optionally open the drawer
      const updatedDrawer = document.querySelector('cart-drawer');
      if (updatedDrawer) {
        updatedDrawer.open = true;
      }

    } catch (err) {
      console.error('Horizon cart refresh failed:', err);
    }
  }

  // Hook into Swym add events
  swat.evtLayer.addEventListener(swat.JSEvents.UIAddedToCart, () => {
    updateHorizonCart();
  });

  swat.evtLayer.addEventListener(swat.JSEvents.UIAddedAllToCart, () => {
    updateHorizonCart();
  });
}

// Register Swym callback
if (!window.SwymCallbacks) window.SwymCallbacks = [];
window.SwymCallbacks.push(onSwymLoadCallback);
</script>
