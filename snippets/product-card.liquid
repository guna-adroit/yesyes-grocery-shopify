{%- doc -%}
  This snippet is used to render a product card.
  It is used in the product block, featured product block, and the product card block.
  The product object is null or when placeholders are rendered.

  @param {object} product - The product object
  @param {object} children - The children of the product card
  @param {object} [block] - The block object
  @param {number} [product_card_gap] - The gap between the product card children (overrides block settings)
{%- enddoc -%}



{% assign block_settings = block.settings %}

{% style %}
  {% if request.visual_preview_mode %}
    product-card-link {
      width: 100%;
      min-width: 250px;
    }
  {% endif %}
{% endstyle %}

{% liquid
  assign has_quick_add = false
  if settings.quick_add and product.available
    assign has_quick_add = true
  endif

  assign has_mobile_quick_add = false
  if has_quick_add and settings.mobile_quick_add
    assign has_mobile_quick_add = true
  endif

  assign product_card_id = 'product-card-link-' | append: block.id | append: '-' | append: product.id
  assign product_card_gap_value = product_card_gap | default: block_settings.product_card_gap

  # Logic to determine which variant URL to use (matching swatch selection logic)
  assign variant_to_link = product.selected_or_first_available_variant
  assign combined_listing_count = product.options_with_values | map: 'values' | map: 'product_url' | compact | size
  assign no_swatch_selected = null

  unless combined_listing_count > 0
    # Simple direct check: which variant owns the featured image?
    if product.featured_media
      assign found_variant = false

      for variant in product.variants
        if variant.featured_media.id == product.featured_media.id
          assign variant_to_link = variant
          assign found_variant = true
          break
        endif
      endfor

      # Check if we need to set no_swatch_selected
      unless found_variant
        # Featured image is not a variant image
        # Check if product has swatches
        for option in product.options_with_values
          assign swatch_count = option.values | map: 'swatch' | compact | size
          if swatch_count > 1
            # Multiple swatches exist but featured image doesn't match any
            assign no_swatch_selected = true
            break
          endif
        endfor
      endunless
    endif
  endunless

  if settings.transition_to_main_product
    assign featured_image = variant_to_link.featured_image
    if featured_image == blank
      assign featured_image = product.featured_media.preview_image
    endif

    if featured_image != blank
      assign featured_media_url = featured_image | image_url: width: 500
    endif
  endif

  assign onboarding = false
  if product.id == empty or product == blank
    assign onboarding = true
  endif
%}

{%- if settings.transition_to_main_product -%}
  <product-card-link
    data-product-id="{{ product.id }}"
    data-featured-media-url="{{ featured_media_url }}"
    data-product-transition="{{ settings.transition_to_main_product }}"
    {% if onboarding %}
      data-placeholder="true"
    {% endif %}
  >
{%- endif -%}
<product-card
  class="product-card"
  data-product-id="{{ product.id }}"
  data-product-variants-size="{{ product.variants.size }}"
  id="product-card-{{ block.id }}"
  data-product-transition="{{ settings.transition_to_main_product }}"
  {{ block.shopify_attributes }}
  {% if no_swatch_selected %}
    data-no-swatch-selected="true"
  {% endif %}
  {% if onboarding %}
    data-placeholder="true"
  {% endif %}
>
  <a
    id="{{ product_card_id | md5 }}"
    {% unless onboarding %}
      href="{{ variant_to_link.url }}"
    {% endunless %}
    class="product-card__link"
    ref="productCardLink"
  >
    <span class="visually-hidden">
      {{ product.title }}
    </span>
  </a>
  <div
    class="
      product-card__content
      layout-panel-flex
      layout-panel-flex--column
      product-grid__card
      spacing-style
      border-style
      gap-style
      {% if block_settings.inherit_color_scheme == false %} color-{{ block_settings.color_scheme }}{% endif %}
    "
    style="
      {% render 'border-override', settings: block_settings %}
      {% render 'layout-panel-style', settings: block_settings %}
      {% render 'spacing-style', settings: block_settings %}
      {% render 'gap-style', value: product_card_gap_value, name: 'product-card-gap' %}
      --quick-add-display: {% if has_quick_add %}flex{% else %}none{% endif %};
      --quick-add-mobile-display: {% if has_mobile_quick_add %}flex{% else %}none{% endif %};
      {% if block_settings.padding-inline-start > 0 %}--zoom-out-padding-inline-start: min(var(--padding-xs), {{ block_settings.padding-inline-start | times: 0.7}}px);{% endif %}
      {% if block_settings.padding-inline-end > 0 %}--zoom-out-padding-inline-end: min(var(--padding-xs), {{ block_settings.padding-inline-end | times: 0.7}}px);{% endif %}
      {% if block_settings.padding-block-start > 0 %}--zoom-out-padding-block-start: min(var(--padding-xs), {{ block_settings.padding-block-start | times: 0.7}}px);{% endif %}
      {% if block_settings.padding-block-end > 0 %}--zoom-out-padding-block-end: min(var(--padding-xs), {{ block_settings.padding-block-end | times: 0.7}}px);{% endif %}
    "
  >
    {{ children }}
    <div class="card_button-wrapper">
    {% if product.variants.size > 1 %}
      {% if product.selected_or_first_available_variant.available %} 
        <div class="quick-add-button-wrapper">
          <button class="button quick-add-btn add-to-cart-button button-secondary" data-product-handle="{{ closest.product.handle }}">
            <span
            class="add-to-cart-text"
          >
              <span class="svg-wrapper add-to-cart-icon">
                {{- 'icon-trolley.svg' | inline_asset_content -}}
              </span>
            <span class="add-to-cart-text__content{% if icon_only_on_mobile %} is-visually-hidden-mobile{% endif %}">
              {{- 'products.product.add_to_cart' | t -}}
            </span>
          </span>
          </button>
        </div>
        
      {% else %}
        <div class="sold-out-button-container">
          <button ref="addToCartButton"
            class="button button-secondary sold-out-button" 
            data-variant-id="{{ product.selected_or_first_available_variant.id }}" disabled>
              Sold out
          </button>
        </div>
      {% endif %}
    {% else %}
      {%- liquid
                 
                  assign product_variant_media = product.featured_media.preview_image | image_url: width: 100
                  if product.featured_media.preview_image != blank
                    assign product_variant_media = product.featured_media.preview_image | image_url: width: 100
                  endif
                -%}

              {% if product.selected_or_first_available_variant.available %}
                <product-form-component
                  data-section-id="{{ section.id }}"
                  data-product-id="{{ product.id }}"
                  data-product-url="{{ product.url }}"
                  on:submit="/handleSubmit"
                  data-quantity-default="{% if product.selected_or_first_available_variant.quantity_rule.min %}{{ product.selected_or_first_available_variant.quantity_rule.min }}{% else %}1{% endif %}"
                >
                  <div
                    class="visually-hidden"
                    aria-live="assertive"
                    role="status"
                    aria-atomic="true"
                    ref="liveRegion"
                  ></div>
                {%- form 'product', product, data-type: 'add-to-cart-form' -%}
                <input type="hidden" name="id" ref="variantId" value="{{ product.selected_or_first_available_variant.id }}">
                <add-to-cart-component
                  ref="addToCartButtonContainer" 
                  data-product-variant-media="{{ product_variant_media }}"
                  data-add-to-cart-animation="true"
                  >
                  <button ref="addToCartButton"
                  class="button button-secondary add-to-cart-button card-atc-button" 
                  type="submit"
                  name="add"
                  on:click="/handleClick"
                  data-variant-id="{{ product.selected_or_first_available_variant.id }}">
                  <span class="svg-wrapper add-to-cart-icon">
                    {{- 'icon-trolley.svg' | inline_asset_content -}}
                  </span>
                    {{- 'products.product.add_to_cart' | t -}}
                  </button>
                  
                </add-to-cart-component>
              {% endform %}
            </product-form-component>
            {% comment %} <product-quantity-control
              class="quantity-control-button"
              data-product-id="{{ product.id }}"
              data-variant-id="{{ product.first_available_variant.id }}"
              hidden
            ></product-quantity-control> {% endcomment %}
           <quantity-input-bulk-component id="{{block.id }}">
            {% assign handle = product.handle %}
            {% assign product = all_products[handle] %}
            {% assign line_quantity = cart | line_items_for: product | sum: 'quantity' %}

              <quantity-input-bulk id="{{block.id }}" class="quick-add-quantity {% if line_quantity > 0 %} visible {% endif %}" data-variant-id="{{ product.first_available_variant.id }}">
                <button data-minus>-</button>
                <input type="number" name="quantity" value="{{ line_quantity }}" min="0" readonly>
                <button data-plus>+</button>
              </quantity-input-bulk>
            </quantity-input-bulk-component>

              {% else %}
                <div class="sold-out-button-container">
                <button ref="addToCartButton"
                  class="button button-secondary sold-out-button" 
                  data-variant-id="{{ product.selected_or_first_available_variant.id }}" disabled>
                    Sold out
                  </button>
                </div>
              {% endif %}
    {% endif %}
  </div>
  </div>
  {% if product.compare_at_price > product.price %}
  {%- assign percent = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price | round -%}
    <div class="sale-ribbon-container">
      <div class="sale-ribbon">{{ percent }}%</div>
    </div>
  {% endif %}
  <div class="product-badges product-badges--top-right wishlist-icon-position">
    <div class="product-badges__badge ">
        <span class="svg-wrapper collection-wishlist-icon">
            {{- 'icon-heart.svg' | inline_asset_content -}}
        </span>
    </div>
  </div>
  
</product-card>
{%- if settings.transition_to_main_product -%}
  </product-card-link>
{%- endif -%}
<style>
  .quick-add-btn{
    width: 100%;
    align-items: center;
    justify-content: center;
    margin-top: 18px;
    border-radius: 8px;
  }
</style>

  <style>
    #product-card-{{ block.id }} .buy-buttons-block{
      display: none;
    } 
    #product-card-{{ block.id }} .quick-add-btn{
      display: flex;
    }
  </style>

<style>
.product-card__content:has(quantity-input-bulk.visible) add-to-cart-component,
.product_variant_item:has(quantity-input-bulk.visible)  add-to-cart-component,
.product-card__content:has(quantity-input-popup.visible) add-to-cart-component,
.product_variant_item:has(quantity-input-popup.visible)  add-to-cart-component{
  display: none !important;
}
quantity-input-bulk,
quantity-input-popup {
    display: none;
    flex-direction: row;
    background-color: #ed1d23;
    height: 55px;
    border-radius: 8px;
}
quantity-input-bulk.visible, quantity-input-popup.visible{
  display: flex;
}
quantity-input-bulk input, quantity-input-popup input{
  width: 100%;
  text-align: center;
  border: none;
  background-color: transparent;
  color: white;
}
quantity-input-bulk input:focus-visible, quantity-input-popup input:focus-visible{
  outline: none;
}
quantity-input-bulk > button, quantity-input-popup > button {
    border: none;
    background: transparent;
    color: white;
    cursor: pointer;
}
quantity-input-bulk > *, quantity-input-popup > *{
  flex: 1;
}
@media screen and (max-width: 820px) {
  quantity-input-bulk, quantity-input-popup {
    height: 45px;
  }
}
@media screen and (max-width: 600px) {
  quantity-input-bulk,  quantity-input-popup{
    height: 35px;
  }
}
</style>
{% stylesheet %}
  product-card-link,
  :not(product-card-link) product-card {
    width: 100%;
  }

  .product-card__placeholder-image svg {
    height: 100%;
  }

  @media screen and (max-width: 749px) {
    .product-card slideshow-arrows .slideshow-control {
      display: none;
    }
  }

  /* Hide the variant swatches for product cards that show a swatches variant picker */
  :is(.product-card):has(swatches-variant-picker-component) .quick-add .variant-option--swatches {
    display: none;
  }

  /* Hide "Add" button for single option product cards that show a swatches variant picker */
  :is(.product-card:not([data-no-swatch-selected])):has(.quick-add__product-form-component--single-option):has(
      swatches-variant-picker-component
    )
    .quick-add__button--choose {
    display: none;
  }

  /* Hide "Add" button for single option product cards that show a swatches variant picker */
  :is(.product-card[data-no-swatch-selected]):has(.quick-add__product-form-component--single-option):has(
      swatches-variant-picker-component
    )
    add-to-cart-component {
    display: none;
  }

  /* Hide "add" button for multi-variant product cards that don't show a swatches variant picker */
  :is(.product-card):has(.quick-add__product-form-component--multi-variant):not(:has(swatches-variant-picker-component))
    .quick-add__button--add {
    display: none;
  }

  /* Hover effect for single variant product cards and product blocks */

  /* stylelint-disable selector-max-specificity */
  :is(.product-card):has(.quick-add__product-form-component--single-variant) .card-gallery:hover {
    & .quick-add__button--choose {
      display: none;
    }

    & .quick-add__button--add {
      display: grid;
    }
  }

  .product-card[data-no-swatch-selected] slideshow-component[data-generic-media-size='1'] slideshow-arrows {
    display: none;
  }

  .product-card[data-no-swatch-selected]
    slideshow-component[data-generic-media-size='1']
    slideshow-arrows:has(+ slideshow-slides slideshow-slide[variant-image]:not([hidden])) {
    display: flex;
  }

  .product-card .variant-option__swatch svg {
    display: none;
  }

  .product-card [data-available-count='0'] ~ svg {
    display: block;
  }

  
{% endstylesheet %}
