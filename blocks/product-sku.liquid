<div class="product-sku-container">
<span class="product-sku">{{ closest.product.selected_or_first_available_variant.sku }}</span>
</div>

<product-sku></product-sku>
<script type="application/json" id="ProductJson-{{ product.id }}">
  {{ closest.product | json }}
</script>
<script type="module">
  class ProductSku extends HTMLElement {
  constructor() {
    super();
    this.skuElement = document.createElement("span");
    this.appendChild(this.skuElement);

    this.onVariantChange = this.onVariantChange.bind(this);
  }

  connectedCallback() {
    this.productData = this.findProductJson();
    if (!this.productData) return;

    // Initial SKU
    this.updateSku(this.productData.variants[0]);

    // Listen for variant change events (all themes)
    document.addEventListener("variant:change", this.onVariantChange);
    document.addEventListener("product:variant-change", this.onVariantChange); // Some themes use this
  }

  disconnectedCallback() {
    document.removeEventListener("variant:change", this.onVariantChange);
    document.removeEventListener("product:variant-change", this.onVariantChange);
  }

  onVariantChange(event) {
    const variant = event.detail?.variant;
    if (variant) this.updateSku(variant);
  }

  updateSku(variant) {
    this.skuElement.textContent = variant.sku || "";
  }

  // UNIVERSAL product JSON finder
  findProductJson() {
    const selectors = [
      '[type="application/json"][data-product-json]',    // Dawn old
      '[type="application/json"][data-product="true"]',  // Many themes
      'script#ProductJson-' + this.getProductId(),       // Dawn new
      'script.ProductJson',                              // Some premium themes
    ];

    for (let sel of selectors) {
      const el = document.querySelector(sel);
      if (el) {
        try {
          return JSON.parse(el.textContent);
        } catch (e) {}
      }
    }

    return null;
  }

  getProductId() {
    const el = document.querySelector("[data-product-id]");
    return el ? el.getAttribute("data-product-id") : "";
  }
}

customElements.define("product-sku", ProductSku);


</script>
{% schema %}
{
  "name": "Product SKU",
  "tag": null,
  "settings": [],
  "presets": [
    {
      "name": "Product SKU",
      "category": "t:categories.product"
    }
  ]
}
{% endschema %}