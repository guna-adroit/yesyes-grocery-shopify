<div class="product-sku-container">
<span class="product-sku">{{ closest.product.selected_or_first_available_variant.sku }}</span>
</div>

<product-sku></product-sku>
<script type="application/json" id="ProductJson-{{ product.id }}">
  {{ closest.product | json }}
</script>
<script type="module">
  import { ThemeEvents, VariantUpdateEvent } from '@theme/events';

class ProductSku extends HTMLElement {
  constructor() {
    super();
    this.skuElement = document.createElement("span");
    this.appendChild(this.skuElement);

    this.onVariantChange = this.onVariantChange.bind(this);
  }

  connectedCallback() {
    this.productData = this.findProductJson();
    if (!this.productData) return;

    // Initial SKU (first variant)
    this.updateSku(this.productData.variants[0]);

    // Listen for Horizon variant update event
    document.addEventListener(ThemeEvents.VariantUpdate, this.onVariantChange);
  }

  disconnectedCallback() {
    document.removeEventListener(ThemeEvents.VariantUpdate, this.onVariantChange);
  }

  onVariantChange(event) {
    const variant = event.detail?.variant;
    if (variant) {
      this.updateSku(variant);
    }
  }

  updateSku(variant) {
    this.skuElement.textContent = variant?.sku || "";
  }

  // Find product JSON for Horizon theme (universal fallback)
  findProductJson() {
    const selectors = [
      '[type="application/json"][data-product-json]',    
      '[type="application/json"][data-product="true"]',
      'script[id^="ProductJson-"]',
      'script.ProductJson',
    ];

    for (let sel of selectors) {
      const el = document.querySelector(sel);
      if (el) {
        try {
          return JSON.parse(el.textContent);
        } catch (_) {}
      }
    }
    return null;
  }
}

customElements.define("product-sku", ProductSku);


</script>
{% schema %}
{
  "name": "Product SKU",
  "tag": null,
  "settings": [],
  "presets": [
    {
      "name": "Product SKU",
      "category": "t:categories.product"
    }
  ]
}
{% endschema %}